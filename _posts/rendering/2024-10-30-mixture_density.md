---
layout: page
title:  "混合密度"
author: mosfet
category: rendering
tags: 渲染 全局照明
---
混合密度是另一种优化路径追踪的技巧。[(见此链接)](https://raytracing.github.io/books/RayTracingTheRestOfYourLife.html)；  
结果如下，可见改善了部分结果，但可用性未知，本文不是着重推荐实现此方法，但留存通用推导。  
似乎是MIS的一种应用；  

<div class="x gr txac">
  <div class="x la flex mg0">
    <div class="x la item3-lg item12 pd0">
      <img src="/assets/i/4-1.png">
    </div>
  </div>
</div>

---
## 回顾蒙特卡洛
通常情况下我永远不会强调之前的知识，但这次作为**例外**。如果目前已经熟悉辐射度理论，那么跳过这段话。  

我假设您知道使用积分和格来测量域这一事实；第二，通过两个积分比率可以得到新引入fx函数的同域平均值。  
采样出空间中特定值的概率分布称为该随机采样变量相关的概率密度函数PDF，简单来说，这是一个因子。  

我们用x、f(x)表示一个随机变量或任意随机结果函数，例如渲染结果的特定像素。  
望值是一种对概率修正乘以实际值的积分，其定义`E(f(x)) = ∫f(x)p(x)dx`通过求和衰减实际值的概率因子获得总体上的平均值。换句话说，它查询整个域。  
当密度相同时，一堆独立随机样本变量iid——通过`x1+x2+.../n`这种方式可以相当简单地获得数值期望解，而无需解析积分形式（但同样应该遵循密度函数以修正迭代值）。这就是蒙特卡洛积分方法的基本根据。  
```ruby
E(f(x)) = ∫f(x)p(x)dx           # E本身就是两项
        ~= 1/N * Σ(i=1..N)xi.   # 数值均值估计

        # 通常，将估计写成g/p的形式称为蒙特卡洛积分
E(f(x)) = ∫f(x)p(x)dx
        ~= 1/N [Σ(i=1..N)g(xi)/p(xi)]
        # 即原始的f(x)p(x) = g，并显式除以p
```

---
## 检查漫反射
检查朗伯的`ρ`和符合其特征的**重要性采样**`pdf`，方程简化为1项。  
我们已隐式修正采样方向到匹配PDF，这将以更快速度收敛到正确答案。  
```cpp
g/p = ρLcosθ/p
li *= self.albedo;
```
改变材质的ρ将从根本上改变渲染，算法将收敛到不同的答案。  

---
## 处理直接贡献
想象一下，实际上可以通过将随机散射突然只指向灯光获得增强光照的效果。  
在代码上，你只需要强制指定这次散射指向被采样的光线。再使用MIS策略和完全随机采样的两个样本结合到一起。  

这种方式称为`混合密度(mixture density)`，但不是MIS的通常用法，本例用于增强直接光照(以抽象的影响方式)。  
这和传统的全局照明计算方式不同。  