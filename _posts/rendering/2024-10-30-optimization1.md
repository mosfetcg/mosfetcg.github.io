---
layout: page
title:  "GI优化技术"
author: mosfet
category: rendering
tags: 全局照明 优化
---

本文需要更新。  

## 辐射度——解析篇
辐射度基础中的一些未能解释的细节以及错误在这里说明，这些缺失在实践中被证明很重要，目前暂时也在本文进行补充。  
笔者习惯上避免重复解释前提知识。本节是一种例外，蒙特卡洛方法的证明链接相当复杂，以至于我需要单独写一个快速回顾的版本，而省去阅读基础的大量时间。
若您现在脑海中还很熟悉它们，请轻松跳过本节。  

#### 随机量、PDF和随机值期望
**review1**开篇我们说明了一种纯微积分式计算函数平均值的方法：这相当于通过格逐步进行完整测量，积分比率为函数总值(Σfdu)和域总值(Σ1du)，这很容易理解。采样格时，我们同时评估函数，当然因为这是它的域。  

有时很难具体地说清楚"随机量"的行为是什么，但请看渲染方程。一方面指的是"格"对应的函数结果，一旦选定格，则结果确定，这两个本身就具有函数关系。而然对结果进行分布分析可能有点抽象，因为可能是颜色等数据，简单而言，每个互斥的域(即格的选项)更容易表示。因此原文中的有关描述不准确。  

选定特定格的机会通常以相对**密度**比较，该密度是一个**相对值**，较小仅概念上表达相对更小。容易通过一维的例子理解这一点，但需要先介绍PDF。  
如果假设所有格的概率总和为标准化1，那么反过来一个格的概率是多少？也许存在一个曲线函数`p(du)du`可以解释这一点，密度是一种神奇的符号，只要具有度量就可以转换为另一种值(格是具有度量的)，这里将格转为实际概率。因此此类积分转换为区域概率。这些曲线就是PDF，密度在这里代表单位概率累积的速率，我们先不用考虑如何正确映射密度的实际数值。  
```ruby
prob = du * p(du)
```
应该明白，有一个简单的方式计算均匀密度的实际值，那就是`1/domain`，因为单位概率面积的总定值不变(否则就不能称为PDF)，越宽，则该常量也越小。  
其次，任何积分为1的曲线都可以作为PDF。  

第二个概念是x~p的期望，这里原文也有点模糊。另外，`x`通常作为**函数结果**解释，而不是格的解释，但后两项可以作为格解释。  
由于我们已经解释了后面两项就是概率，因此该表达式只是采样结果值 * 某种概率。既然你知道根据概率缩放的值，无论划分宽度多少，这些总和代表什么？为什么代表期望？  
```ruby
E(x) = ∫x*p(du)du         # but why?
```
下面来看这个：如果我们将单位概率转为实际足够样本的比例，期望本质上应该由以下式给出：  
```ruby
1000 x1 + 2000 x2 + ...   # half prob respectively
  /  3000                 # 记住我们可以单位化样本数量，coefficients为概率，并且总次数变为/1.0
= 0.33x1 + 0.66x2 / 1
= x1+2x2 / 3              # 无论数量如何，都应该代表相同过程和结果，即f的平均值

# rewrite with normaliztion
# thats our E(x)!
(p)(x1+x2) / 1
#pxdx   x
```
这样应该令人信服，概率确实在期望中起到作用，(式1)也表示理论上的参与度，在所有事件中这些值的参与贡献不同。  
所谓的估值器只是持续记录上述过程f采样后的平均值(如3000个样本)。你当然需要小心遵循相同的概率来产生样本，否则与贡献地图将不匹配。  
有兴趣的读者可以研究一下下项的`1`和比率方法有无联系。  

#### 估值
原文这里有一些未知描述，尽管这些材料可能是正确的表述。目前应该将IST作为引用。  
```ruby
# 5-45
         I(f) = ∫S|f(du)du
         E(f) = ∫S|f(du)p(du)du          # 证明如前所述
    dui~p, fi = f(dui)                   # SAMPLES : dui -> fi，尾缀i表示一个样本
      EST(fi) = 1/N * Σ(i=1..N)fi.       # 事实，所有按i~p产生的样本的均值近似于期望
  #estimator 这里的参数指的是求和项

# 可改写为
E(f) = ∫[g=fp]du ~= EST(g / pdu)
```
首先，估计中iid样本的必要条件是PDF`vari~p`，两式相等正确的原因在于假设样本已遵循此分布，否则，就不是同一个期望值。我们已经在上面证明了这一点。  

**持平(unbiased)**  
```ruby
E(v1+v2) = Ev1 + Ev2    # ①平均值应该相等
E(av)    = aE(v)        # ②常数不影响
E(Σfi)   = ΣE(fi)       # "样本和的期望"等于每个样本期望之和  注意不是样本的期望
                        # 这可以用①来证明  
```
```ruby
# 5-46
E(ESTfi) = E[1/N * Σfi]
         = 1/N E[Σfi]
         = ... ΣE(fi)
         = ... ΣE[f(dui)]  # 该样本来自于评估函数，替换
         = ... Σ∫
if p = 1, = I(f)|S
```
蒙特卡洛形式。评估一个f的积分的时候，估值器表达式为`fdui / pdui`，我们可以无偏求解该积分。  
```ruby
EST(fdui/pdui) = ? = 1/N* Σ(fdui / pdui)
E(↑) = ∫S|fdx              # prove: 5-47
```

#### 辐射强度
`辐射强度(radiant intensity)`的定义是`I(σ) = ΔΦ/Δσ`，等于立体角上的光谱功率。在这里是一个不常用的术语。  

#### CDF
`cumulative pdf`指PDF的积分累积函数(累积单位概率)，通常用大`P(x)`表示。  

#### CDF逆方法选择事件
可以均匀地划分CDF的域，如每隔1/10，并检查每段概率的累积情况。  
考虑一个均匀随机数`r = rand()`落在CDF的像上，求反找出划分的域在哪里，并且进行插值近似。  
表达式上这是`select_domain = CDF^-1(r)`，这称为逆方法。  

#### 二分方法选择事件
递归求解CDF相等(50%)的地方，停留在合理的深度。然后递归依次产生r检查(>0.5)，选择一侧区域，并在该最小的细分区域随机均匀生成一个样本。  
对于复杂曲线，求解CDF中点可以使用数值估计完成任务。  

---
## 参考1
熟悉[《Ray Tracing: The Rest of Your Life》](https://raytracing.github.io/books/RayTracingTheRestOfYourLife.html)这本书的读者  
可能记得Peter Shirley列举了几种重要性采样的实践，如更匹配漫反射BRDF的非均匀采样。更具启发意义的可能是灯光PDF以及采样(强制导向灯光)。这种直接光采样不同于常规的积分方法，但可以达到基本正确的结果。如果您理解了全局光照的问题，则可以理解这种方法的合理性。我在这里再次强调理解问题本身更重要，而不是推崇某种解决方案，读者需要自己理解可行性并决定自己的使用偏好。  
若不清楚选择PDF以及采样行为对结果的不同影响，请见光线追踪一文。  
<div class="x gr txac">
  <div class="x la flex mg0">
    <div class="x la item3-lg item12 pd0">
      <img src="/assets/i/4-1.png">
    </div>
  </div>
  <p>图1：增强灯光的贡献</p>
</div>

