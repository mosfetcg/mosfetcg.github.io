---
layout: page
title:  "GI优化技术2"
author: mosfet
category: rendering
tags: 全局照明 优化
---

## 参考1
今年年初，我的一个重大突破是终于实现了[《Ray Tracing: The Rest of Your Life》](https://raytracing.github.io/books/RayTracingTheRestOfYourLife.html)系列的所有功能。是时候抛开这本书了进行下一步了，以下是我是对本书的看法，以及一些实用技巧的摘录。我希望把本书的一般技术的清晰抽象留在这里，以便用此方法进行实现时可以参考。  

<div class="x gr txac">
  <div class="x la flex mg0">
    <div class="x la item3-lg item12 pd0">
      <img src="/assets/i/4-1.png">
    </div>
    <div class="x la item3-lg item12 pd0">
      <img src="/assets/i/4-2.png">
    </div>
  </div>
  <p>Mixture Densities -method</p>
</div>

初见本书介绍的方法(所谓的**密度混合**)似乎会觉得不可思议。实际上这印证了我们之前对渲染正确性思考的想法。在这个术语中，重要性采样指的是将光线散射到您认为的重要区域，
通过这样一个简单的原理，我们可以产生多种采样策略，甚至同样可以应用MIS框架。作者认为这是传统方法的代替，尽管它不一定流行。

如果您理解了全局光照的问题，则可以理解各种标准以外方法的合理性。我在这里再次强调理解问题本身更重要，而不是推崇某种解决方案，读者需要自己理解可行性并决定自己的使用偏好。若不清楚选择PDF以及采样行为对结果的不同影响，请见光线追踪一文。  

### 小记
(**第六章**)开始首先研究了之前实现的朗伯漫反射体的采样策略，当然这里也比较了半球漫反射体。请注意区分朗伯体和均匀半球散射两种材料(见rt5.1)。回忆一下，两种材料的散射分布是不同的(本质上只有拒绝方法上的区别)，自然需要不同的采样方式。  

朗伯体的常数反射率告诉我们它本质是一个公平的光源。  
这不影响渲染方程，剩下的投影效应引入了光照衰减，积分的形状带有cos项，为了找出更匹配该形状的PDF，  
我们推导：  
```ruby
EST = [R/PI Licos dvi] / ?p
∫hs|Ccosdu = 1 thus C = 1/Pi thus pdf = cosvi / Pi
EST = Li * R
```
注意，为了匹配PDF，您的样本(反射方向)必须按照该分布产生。  

第七章研究了遵循PDF在半球上生成对应分布方向的方法，利用一个非平行表面N的向量取两次Cross构成子空间系可以从任何表面参考发送此类随机数。  
第十章开头编写了PDF类，一是生成遵循了PDF的随机方向，二为查询特定结果的密度。这两者分别用于弹射dvi以及计算/pvi。  
对于灯光(或任何需要直接采样的东西)的PDF，则单独为其几何表面编写采样随机样本和pdf。  

混合密度方法使用以下公式：  
```ruby
pMix = w0p0 + w1p1 + ……
     #  ΣW = 1
# say
pM1 = 0.5pCos =+ 0.5pLight
```
正确使用的方式是，方向根据产生一个ξ并根据w的比重来随机选择一个即可。PDF的值由该具体方向询问两个PDF并进行W的配重混合得到。  
但我们的估值器是什么呢？"不想用阴影光线来解决任何给定点的直接照明问题，只使用向光源发送更多光线。"在这里是有道理的。  
因此只是渲染方程，这里有个微妙的细节，为了最后一项，在计算灯光时，`pdf2 = r²/cos/A`，而不是`1/A`。  

玻璃体的有关计算细节如下：  
```ruby
x = sin(θ)cos(ϕ)
y = sin(θ)sin(ϕ)
z = cos(θ)

# recall all optimization1 then

ξ = ∫0..θ|2Pifθsinθdθ
# 为了找出球体所对的锥体最大角度(类似于FOV)
# 先找出一般关系
let C = fθ
ξ = 2PiC -cos|θ-0 = (1-cosθ)2PiC
cosθ = 1 - ξ/2PiC

# 使得钳处的概率为1，则CDF = 1 at θmax，求得C
C = -1 / (2Pi (cosθmax-1))
&& cosθ = 1+ξ(cosθmax -1)
# 现在可以转为极系向量

sinθmax = Rcircle / dist(p,c)
so... cosθmax

# 灯光PDF为 1/Area
# 请使用该公式：
area = ∫∫2Pi && θmax|sinθ (...dθd) = 2Pi (1-cosθmax)
```

### 评论
实际上，回过头来看，Peter Shirley在本系列中很多地方的解释是非常差的，尤其是第二本。最后一部最具价值，尚可，但仍缺乏部分(甚至严重)。但这似乎从风格来看也可以理解其目的不在于让您满意，严肃的理论仅在IST或者PBR中更完整的描述，也更能满足您的信心。但它们并不适合在第一次研究，本书作为上手读物仍然是最具价值的。  

他提及的阴影光线，其实就是指光线追踪的基础技术。"我没有讲解阴影光线（而是选择让光线更倾向于指向光源），也没有讲解双向方法、Metropolis方法或光子映射。你会在所谓的“专业光线追踪器”中找到很多这类技术"可以概括所有术语差异。  

我把想法写在这里，以便我们更好地看待下一步工作。例如，可以研究如作者所推荐的其他技术，本书未涵盖的光谱建模、更多BRDF模型。  

**遗留物品**  
我无法明确结论的最后一个问题是关于第六章朗伯体和半球体的区别，这似乎与其在方程中显式表达散射修正的术语差异有关，实在无法理解为什么要拆分成而不是用BRDF。如果您需要它，请按照他的思路进行计算和推导。如果你只需要朗伯体，那么一切都早已准备好了，我把这个问题留在这里是因为这确实是最后一个没有解决的要点，如果您需要他，那么也能快速开始省去查找下面符号的时间。  
```ruby
# 其术语是
R pScat Li / p
BRDF = R pScat / cos # 转换

# pScatter 是直接从目标散射分布推测的，例如对于朗伯集中型：
pScatter = cos/pi
# /p 和pScatter相同的形状，则对朗伯完美采样
# 我们也可以验证其BRDF正确

# 6.2 在都不变的情况下仅改变/p = 1/2pi，f实际上没变，形状可能只有1/PI是相同的。  
# 这节到底有什么意义？为什么不是按新p采样破坏估值器？

# 6.3
# 均匀半球散射是一种不同的漫反射材质。散射分布为pScatter = 1/2pi，生成半球样本。
# /p = 1/2pi，因此也完美采样。
```