---
layout: page
title:  "湖"
author: mosfet
category: scene
tags: 场景
---
这是一些对于水面渲染的早期经验和理解。  

## 场景描述
该场景只包含两个平面，其中一个建模波浪起伏的湖面，特别是使用FBM产生自相似的形状。另一个用于水底，一些石头，纹理来自于[polyhaven.com](https://polyhaven.com/textures)。您至少应该包含`ao、diff、disp、rough`四种类型用于一般着色。  

<iframe src="https://editor.p5js.org/mosfet-archive/full/3ZQ76doA9" width="760" height="800" class="x la dspln dsplb-md"></iframe>

## 步骤
我们可以通过我们对水面的建模要求进行初步分析以检查是否存在可用的导出SDF。唯一可以做的事情是查看脚下的曲面是什么，这是由于参数曲面本身的行为带来的境况。但是幸运的是我们可以不用真的沿着路线以固定小步摸索，高度差可以直接作为估计距离的指导。可以轻松验证这一点的合理性，尽管将它作为SDF时距离不是线性减少的。  

<div class="x la bdl2 pdl2 sk bg-gunmetal05 tx-antiqueRuby1">
<p>
参数曲面也有点“隐含”吗？因为我们仍然需要给出参数才能看到它的一部分？  
</p>

<p>
有趣的想法！虽然参数化曲面和隐式曲面的定义方式有所不同，但确实存在一些相互作用。
因此，虽然参数化曲面为您提供直接控制，但您仍然需要指定参数。它与其说是“隐藏”，不如说是隐含，但你的洞察力并没有错！这种二元性使几何成为一个极其丰富的探索领域。感觉自己像个几何学家了吗？
</p>
</div>

```cpp
float sdLake( in vec2 st) {
  return fbm(st);
}
float sdf( in vec3 p, in int id) {
  if (id == 1) {
    float zdiff = p.z - sdLake(p.xy);
    return zdiff;
  } else {
    // return dot(p - vec3(0.0, 0.0, -2.0), vec3(0.0, 0.0, 1.0)) + 0.1;
    return dot(p - vec3(0.0, 0.0, -2.0), vec3(0.0, 0.0, 1.0)) - textureLoad(p, 2).r;
  }
```

## 交叉优化
由于显示细节会随着距离的增加而呈反线性衰减，因此我们可以将误差增加到与之相关，这可以节省大量渲染时间。
```cpp
if (traveled < 10.0) {
  if (safe_step < 0.01) return traveled;
} else {
  if (safe_step < 0.01 + (traveled - 10.0) * 0.005) return traveled;
}
```

## 调整着色
理论上，完全可以使用一些全局光照方法对此类水面进行照明获得最佳实践效果。  
本场景不致力于此实现，而是转而模仿一些计算机图形中最常见的水渲染技术，通常是基于光栅化和FBO的，但本质上是通用的。  
读者可以在海豚书原文和 或网络教程 **[该视频链接](https://www.youtube.com/watch?v=LgnLB07HDSw&t=69s)**中找到引用。  

总的来说，您通过已渲染帧的结果、或者单独渲染一个画面分别为最终画面提供反射和折射效果。  
通常，这种反射、折射的选择尽可能地便宜。一个特征是编写者通常会将场景一分为二，然后单独考虑它们的结果，这种结果对于整个画面都是有着色的，他们通常还会直接忽略折射中的一些典型现象，而产生非物理的结果，但这实际上不会有太大问题，没人会关注这种细节。  
以至于越来越追求实用性，用纹理产生乱流和标准向量。甚至不需要任何标准向量就混合折射和反射。  

本场景基本上也利用了类似的有效近似，我们最好在混合前讨论一些基本策略。  
首先，反射很简单，这部分的照明原本就来自于天空。但很难表现出折射的真实颜色，因为湖底的表面又不是类似于水面的镜面。这里我遵循了一些近似全局照明的方式，使用与背景中的大致类似的颜色作为灯光，而不实际取决于它们。随后我加入了一些比尔法赋予水的可能杂质颜色，补充了一些反射灯光，因为通常水面在高亮光源前产生波光粼粼的视觉效果，仅反射黄色的圆盘太阳很难达到这种目的。  